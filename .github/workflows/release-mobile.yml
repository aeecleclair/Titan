name: Release mobile bundles

on:
  workflow_dispatch:
  push:
    branches:
      - 'main'
      - 'alpha'
    tags:
      - 'v*.*.*+*'

jobs:
  build:
    name: Release titan-${{ steps.get-ref.outputs.branch }} ${{ matrix.name }}
    runs-on: macos-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: "appbundle --release"
            name: "AAB"
            path: build/app/outputs/bundle/release/app-signed.aab
          - target: "ipa --release"
            name: "IPA"
            path: build/ios/ipa/*.ipa
    
    steps:
      - name: Determine ref
        id: get-ref
        run: |
          branch=${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}
          tag=${GITHUB_REF#refs/*/}
          versionCode=${tag##*+}
          versionName=${tag%+*}
          versionName=${versionName#v}
          echo "branch=$branch" >> $GITHUB_OUTPUT
          echo "versionCode=$versionCode" >> $GITHUB_OUTPUT
          echo "versionName=$versionName" >> $GITHUB_OUTPUT
          
      
      - name: Checkout 🛎️
        uses: actions/checkout@v3
      
      - name: Setup Flutter SDK
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"
          flutter-version: "3.13"
          cache: true
      
      - name: Get Packages
        run: flutter pub get
      
      - name: Cleanup 🧹
        run: flutter clean
      
      - name: Configure env
        run: |
          echo "THE_MOVIE_DB_API=$THE_MOVIE_DB_API" >> .env
          echo "DEBUG_HOST=$DEBUG_HOST" >> .env
          echo "RELEASE_HOST=$RELEASE_HOST" >> .env
        env:
          THE_MOVIE_DB_API: ${{ secrets.THE_MOVIE_DB_API }}
          DEBUG_HOST: ${{ secrets.DEBUG_HOST }}
          RELEASE_HOST: ${{ secrets.RELEASE_HOST }}
      
      - name: Build 🔧
        run: flutter build ${{ matrix.target }} --build-name ${{ steps.get-ref.outputs.versionName }} --build-number ${{ steps.get-ref.outputs.versionCode }}
      
      - name: Create the Keystore
        if: matrix.name == "AAB"
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
        run: echo $KEYSTORE_BASE64 | base64 -d > $RUNNER_TEMP/myecl.keystore
      
      - name: Sign AAB
        if: matrix.name == "AAB"
        run: jarsigner -keystore $RUNNER_TEMP/myecl.keystore -storepass ${{ secrets.KEYSTORE_PASSWORD }} -keypass ${{ secrets.KEYSTORE_PASSWORD_ALIAS }} -sigalg SHA256withRSA -digestalg SHA-256 -signedjar build/app/outputs/bundle/release/app-signed.aab build/app/outputs/bundle/release/app.aab MyECL
      
      - name: Upload Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: titan-release
          path: ${{ matrix.path }}
          if-no-files-found: ignore